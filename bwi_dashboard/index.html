<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="shortcut icon" href="ico/favicon.ico">

    <title>BWI Web Tool</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" />

    <!-- Custom styles for this style -->
    <link href="css/dashboard.css" rel="stylesheet">

    <!-- Import necessary javascript files -->
    <script src="js/easeljs.min.js"></script>
    <script src="js/eventemitter2.js"></script>
    <script src="js/roslib.js"></script>
    <script src="js/ros2d.min.js"></script>
    <script src="js/nav2d.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/mjpegcanvas.min.js"></script>
    <script src="js/CustomKeyboardTeleop.js"></script>
    <script src="js/docs.min.js"></script>
    <script src="js/config.js"></script>

    <script>

     

  // Initialize ROSBRIDGE connection
  var ros;
  function initializeROS()
  {
     ros = new ROSLIB.Ros();

     // // If there is an error on the backend, an 'error' emit will be emitted.
     ros.on('error', function(error) {
       console.log('Error connecting to ' + rosBridgeAddress);
     });

     // Find out exactly when we made a connection.
     ros.on('connection', function() {
       console.log('Connection made to ' + rosBridgeAddress);
     });

     // // Create a connection to the rosbridge WebSocket server.
     ros.connect(rosBridgeAddress);
    
  }


  //SUBSCRIBE TO TOPICS
  var sensorListeners = [];
  var listenerCount = 0;
  function createListener(topicname, messagetype, subtopicnames)
  {
     // Create a Topic object with details of the topic's name and message type.
     sensorListeners[listenerCount] = new ROSLIB.Topic({
       ros : ros,
       name : topicname,
       messageType : messagetype
     });

     var JSONsubtopicnames = createJSONSubTopicArray(subtopicnames.slice(0));

     // Then we add a callback to be called every time a message is published on this topic.
     var currentCount = listenerCount;
     sensorListeners[listenerCount].subscribe(function(message) {

       document.getElementById('trUpdated' + currentCount).innerHTML = formatNowTimestamp();
       document.getElementById('trValue' + currentCount).innerHTML = '<div style="min-width:500px;" class="jsondiv">' + processListenerJSON(message, JSONsubtopicnames) + '</div>';

     });

     listenerCount++;

  }

  // Used as helper method to decide if we need to simplify our incoming topic or not
  function processListenerJSON(jsonmessage, subtopicnames)
  {
    //Check to see if the subtopics are empty
    var emptySubtopics = true;
    for(var i =0; i<subtopicnames.length && emptySubtopics; i++)
    {
      for(var j =0; j<subtopicnames[i].length && emptySubtopics; j++)
      {
        if(subtopicnames[i][j]!="")
        {
          emptySubtopics = false
        }
      }
    }

    if(emptySubtopics || subtopicnames.length==0)
    {
      // No subtopics to filter by, can just return the message
      return JSON.stringify(jsonmessage, null, 2);
    }
    else
    {
      // Need to simplify the message with our subtopics
      return JSON.stringify(getSimplifiedJSON(jsonmessage, subtopicnames.slice(0)), null, 2);
    }
  }

  //simplify JSON for sensor by getting rid of subtopics that aren't included in subtopicnames
  function getSimplifiedJSON(jsonmessage, subtopicnames)
  {
    if(subtopicnames.length==0)
    {
      return jsonmessage;
    }
    else
    {
      for(var attrname in jsonmessage)
      {
        var attrExists = false;

        for(var i=0; i<subtopicnames.length; i++)
        {
          if(subtopicnames[i][0]==attrname)
          {
            attrExists=true;
            break;
          }
        }

        if(!attrExists)
        {
          delete jsonmessage[attrname];
        }
      }

      var subtopicnamesshifted = shiftJSONSubTopicArray(subtopicnames.slice(0));
      for(var attrname in jsonmessage)
      {
        var attrFinal = false;
        for(var i=0; i<subtopicnames.length; i++)
        {
          if(subtopicnames[i][0]==attrname && subtopicnames[i].length==1)
          {
            attrFinal=true;
            break;
          }
        }
        if(!attrFinal)
        {
           jsonmessage[attrname] = getSimplifiedJSON(jsonmessage[attrname], subtopicnamesshifted.slice(0));
        }
      }

      return jsonmessage;
    }
  }

  //Adjust the subtopic arrays to point to the next node
  function shiftJSONSubTopicArray(subtopicnames)
  {
    for(var i = subtopicnames.length-1; i>=0; i--)
    {
      if(subtopicnames[i].length>1)
      {
        subtopicnames[i] = subtopicnames[i].slice(1);
      }
      else
      {
        subtopicnames.splice(i,1);
      }
    }
    return subtopicnames;
  }

  //create subtopic array that converts 'node1/node2/node3' to [node1,node2,node3]
  function createJSONSubTopicArray(subtopicnames)
  {
    for(var i=0; i<subtopicnames.length; i++)
    {
      subtopicnames[i] = subtopicnames[i].split("/");
    }
    return subtopicnames;
  }

  // Create the rows for the sensor table
  function initializeSensorTable()
  {
    var tbodySubscr = document.getElementById('tbodyTableSubscriptions');
      if (tableSubscriptions.length>0)
      {
        var counter = 0;
         tableSubscriptions.forEach(function(subscr) {

            var trSubscr = document.createElement('tr');
            trSubscr.id = 'trSubscr' + counter;

            var tdTopic = document.createElement('td');
            tdTopic.innerHTML = subscr.TopicName;

            var tdType = document.createElement('td');
            tdType.innerHTML = subscr.MessageType;
            tdType.className = 'hidden-xs hidden-sm';

            var tdUpdated = document.createElement('td');
            tdUpdated.id = 'trUpdated' + counter;

            var tdValue = document.createElement('td');
            tdValue.id = 'trValue' + counter;

            counter++;

            trSubscr.appendChild(tdTopic);
            trSubscr.appendChild(tdType);
            trSubscr.appendChild(tdUpdated);
            trSubscr.appendChild(tdValue);
            tbodySubscr.appendChild(trSubscr);
            
         });
      }
      else
      {
         var trSubscr = document.createElement('tr');
         trSubscr.id = 'trSubscrEMPTY';
         var tdEmpty = document.createElement('td');
         tdEmpty.colSpan = 4;
         tdEmpty.innerHTML = '<center>NO SUBSCRIPTONS</center>';
         trSubscr.appendChild(tdEmpty);
         tbodySubscr.appendChild(trSubscr);
      }
  }

  // Initialize subscriptions to log at the top of the dashboard
  function initializeLogSubscriptions()
  {
    logTopics.forEach(function(subscr) {
        var logListener = new ROSLIB.Topic({
           ros : ros,
           name : subscr.TopicName,
           messageType : subscr.MessageType
         });

         var JSONsubtopicnames = createJSONSubTopicArray(subscr.SubTopicNames.slice(0));

         // Then we add a callback to be called every time a message is published on this topic.
         logListener.subscribe(function(message) {
            logToScreen(subscr.TopicName, processListenerJSON(message, JSONsubtopicnames));
         });
     });
  }

  // Format timestamp for use in sensors and logs
  function formatNowTimestamp() {
      var dt = new Date();

      var hours = dt.getHours();
      var minutes = dt.getMinutes();
      var seconds = dt.getSeconds();

      if (hours < 10) 
       hours = '0' + hours;

      if (minutes < 10) 
       minutes = '0' + minutes;

      if (seconds < 10) 
       seconds = '0' + seconds;

      return hours + ":" + minutes + ":" + seconds;
  }  


  // Create subscriptions for each of the topics we want to monitor in the sensors table
  function createSensorSubscribers()
  {
     listenerCount = 0;
     tableSubscriptions.forEach(function(subscr) {
        createListener(subscr.TopicName, subscr.MessageType, subscr.SubTopicNames);
     });
  }

  // Unsubscribe and delete listeners for current sensor topics
  function deleteSensorSubscribers()
  {
     var counter = 0;
     tableSubscriptions.forEach(function(subscr) {
        sensorListeners[counter].unsubscribe();
        sensorListeners[counter] = null;
        counter++;
     });
     listenerCount = 0;
  }

  // Initialize the video connection
  var mjpegVideoViewer;
  function createVideoSubscribers()
  {
      // --------------------------------------------------------
      // Determine the size of the video that we can fit on the screen
      // --------------------------------------------------------
      var desiredVideoWidth = 640; //desired/max width
      var desiredVideoHeight = 480; //desired/max height

      var realVideoWidth;
      var realVideoHeight;

      //Current size of window
      var windowWidth = ("innerWidth" in window 
                  ? window.innerWidth
                  : document.documentElement.offsetWidth); 
      var windowHeight = ("innerHeight" in window 
               ? window.innerHeight
               : document.documentElement.offsetHeight); 

      //How big of a video can we fit for our width and height?
      var minVideoWidth = Math.min(desiredVideoWidth,  windowWidth);
      var minVideoHeight = Math.min(desiredVideoHeight, windowHeight);

      //If we resize our video according to the resolution we chose in config, 
      //what will we have to shift our videoWidth and videoHeight to respectively
      var shiftedVideoWidth = (minVideoHeight/desiredVideoHeight) * realVideoWidth;
      var shiftedVideoHeight = (minVideoWidth/desiredVideoWidth) * desiredVideoHeight;

      //check to see if Height takes priority over Width
      if(shiftedVideoWidth < minVideoWidth)
      {
         realVideoWidth = shiftedVideoWidth;
         realVideoHeight = minVideoHeight;
      }
      else
      {
         realVideoWidth = minVideoWidth;
         realVideoHeight = shiftedVideoHeight;
      }

      // --------------------------------------------------------

    // Create the main viewer.
    mjpegVideoViewer = new MJPEGCANVAS.MultiStreamViewer({
      divID : 'mjpegVideoScreen',
      host : rosMjpegServerInfo.Host,
      port : rosMjpegServerInfo.Port,
      quality : rosMjpegServerInfo.Quality,
      width : realVideoWidth,
      height : realVideoHeight,
      topics : rosMjpegServerInfo.Topics,
      labels : rosMjpegServerInfo.Labels
    });
  }

  // This doesn't erase the subscription, but it removes the viewer
  function deleteVideoSubscribers()
  {
      document.getElementById('mjpegVideoScreen').innerHTML = "";
      mjpegVideoViewer = null;
  }

  // Initialize the Navigation connection
  var navWindowViewer;
  var navWindowClient;
  function createNavSubscribers()
  {

      // --------------------------------------------------------
      // Determine the size of the Nav that we can fit on the screen
      // --------------------------------------------------------
      var desiredNavWidth = 800; //desired/max width
      var desiredNavHeight = 800; //desired/max height

      var realNavWidth;
      var realNavHeight;

      // Current size of window
      var windowWidth = ("innerWidth" in window 
                  ? window.innerWidth
                  : document.documentElement.offsetWidth)-25; 
      var windowHeight = ("innerHeight" in window 
               ? window.innerHeight
               : document.documentElement.offsetHeight)-25; 

      //How big of a Nav can we fit for our width and height?
      var minNavWidth = Math.min(desiredNavWidth, windowWidth);
      var minNavHeight = Math.min(desiredNavHeight, windowHeight);

      //If we resize our Nav according to the resolution we chose in config, 
      //what will we have to shift our NavWidth and NavHeight to respectively
      var shiftedNavWidth = (minNavHeight/desiredNavHeight) * desiredNavWidth;
      var shiftedNavHeight = (minNavWidth/desiredNavWidth) * desiredNavHeight;

      //check to see if Height takes priority over Width
      if(shiftedNavWidth < minNavWidth)
      {
         realNavWidth = shiftedNavWidth;
         realNavHeight = minNavHeight;
      }
      else
      {
         realNavWidth = minNavWidth;
         realNavHeight = shiftedNavHeight;
      }

      // Create the main viewer.
       navWindowViewer = new ROS2D.Viewer({
         divID : 'navWindow',
         width : realNavWidth,
         height : realNavHeight
       });

       // Setup the nav client.
       navWindowClient = NAV2D.OccupancyGridClientNav({
         ros : ros,
         rootObject : navWindowViewer.scene,
         viewer : navWindowViewer,
         serverName : navWindowServerName
       });

       //for normal map but without the location
       // navWindowClient = ROS2D.OccupancyGridClient({
       //   ros : ros,
       //   rootObject : navWindowViewer.scene
       // });

  }

  // This doesn't erase the subscription, but it removes the viewer
  function deleteNavSubscribers()
  {
      document.getElementById('navWindow').innerHTML = "";
      navWindowViewer = null;
  }

  // Initialize the teleop connection
  var teleopClient;
  function createTeleopSubscribers()
  {
      // Create teleop client
      teleopClient = new KEYBOARDTELEOP.Teleop({
        ros : ros,
        topic : teleopTopic
      });

      // Create the slider for the speed
      $('#teleopSpeedSlider').slider({
        range : 'min',
        min : 0,
        max : 100,
        value : 100,
        slide : function(event, ui) {
          // Change the speed label.
          $('#teleopSpeedLabel').html('Speed: ' + ui.value + '%');
          // Scale the speed.
          teleopClient.scale = (ui.value / 100.0);
        }
      });

      // Set the initial speed
      $('#teleopSpeedLabel').html('Speed: ' + ($('#teleopSpeedSlider').slider('value')) + '%');
      teleopClient.scale = ($('#teleopSpeedSlider').slider('value') / 100.0);

  }

  // Removes teleop client
  function deleteTeleopSubscribers()
  {
      teleopClient.scale = 0;
      teleopClient = null;
  }

  // Carries out action for navigation buttons
  function navAction(action)
  {
    if(action=='left')
    {
      navWindowViewer.scene.x +=50;
    }
    else if(action=='right')
    {
      navWindowViewer.scene.x -=50;
    }
    else if(action=='down')
    {
      navWindowViewer.scene.y -=50;
    }
    else if(action=='up')
    {
      navWindowViewer.scene.y +=50;
    }
    else if(action=='zoomin')
    {
      // 1.5 is arbitrary, change the number to change how fast the zooming happens
      navWindowViewer.scene.scaleX = navWindowViewer.scene.scaleX*1.5;
      navWindowViewer.scene.scaleY = navWindowViewer.scene.scaleY*1.5;
    }
    else if(action=='zoomout')
    {
      // 1.5 is arbitrary, change the number to change how fast the zooming happens
      navWindowViewer.scene.scaleX = navWindowViewer.scene.scaleX/1.5;
      navWindowViewer.scene.scaleY = navWindowViewer.scene.scaleY/1.5;
    }
  }
 

  // initialize the drop downs for the connection/subscription defaults
  function initializeConfigOptions()
  {
    for(var index in connectionConfig) {
      $('#connectionSelect').append('<option value="' + index + '">' + index + '</option>');
    }

    for(var index in subscriptionConfig) {
      $('#subscriptionSelect').append('<option value="' + index + '">' + index + '</option>');
    }

    // Create empty fields for Custom entries
    addVideoTopic('');
    addSensorTopic('','',[]);
  }

  // Get url parameter for the id "sname"
  function getParam ( sname )
  {
    var params = location.search.substr(location.search.indexOf("?")+1);
    var sval = "";
    params = params.split("&");
      // split param and value into individual pieces
      for (var i=0; i<params.length; i++)
         {
           temp = params[i].split("=");
           if ( [temp[0]] == sname ) { sval = temp[1]; }
         }
    return sval;
  }

  // Process the url parameters (if any)
  function processParamInitialization()
  {
    //initialize to parameter values
    var connectionChoice = getParam("c");
    var subscriptionChoice = getParam("s");
    if(connectionChoice == "" && subscriptionChoice == "")
    {
      alert("ERROR: No connection or subscription configuration included.");
    }
    else if(connectionChoice == "")
    {
      alert("ERROR: No connection configuration included.");
    }
    else if(subscriptionChoice == "")
    {
      alert("ERROR: No subscription configuration included.");
    }
    else
    {
      //choices included
      if(!(connectionChoice in connectionConfig))
      {
        alert("ERROR: Connection configuration doesn't exist.");
      }
      else if(!(subscriptionChoice in subscriptionConfig))
      {
        alert("ERROR: Subscription configuration doesn't exist.");
      }
      else
      {
        //choices are valid, start the dashboard with the options chosen
        $("#connectionSelect").val(connectionChoice).trigger('change');
        $("#subscriptionSelect").val(subscriptionChoice).trigger('change');
        connectToROS();

      }
    }
  }

  
  // This is run when the page is started
  function initialize()
  {
    //redirect console output
    if (typeof console  != "undefined") 
    if (typeof console.log != 'undefined')
    {
        console.olog = console.log;
    }
    else
    {
        console.olog = function() {};
    }

    console.log = function(message) {
        console.olog(message);
        logToScreen('BWI Dashboard', message);
    };
    console.error = console.debug = console.info =  console.log

    //initialize config
    initializeConfigOptions();
    if(location.search.indexOf("?") >= 0)
    {
      // URL Parameters exist, process them
      processParamInitialization();
    }
    else
    {
      // No URL Parameters exist, carry on as normal
      $('#configurationcontainer').css({ "display": ''});
    }
  }


</script>

  </head>

  <body onload="initialize()">

  <!-- HEADER -->
    <div class="navbar navbar-inverse" role="navigation" style="margin-top:-50px;">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">BWI Web Tool</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Dashboard</a></li>
            <!-- <li><a href="#">Settings</a></li> -->
            <!-- <li><a href="#">Profile</a></li> -->
            <!-- <li><a href="#">Help</a></li> -->
          </ul>
        </div>
      </div>
    </div>


    <div class="container-fluid">

    <!-- CONFIGURATION SCREEN -->
      <div id="configurationcontainer" style="display:none;">
        <h1 class="page-header">Configuration</h1>

        <div class="panel panel-default">
          <div class="panel-heading clearfix">
            <h3 class="panel-title pull-left">Connection</h3>
            <div class="btn-group pull-right">
              <button type="button" class="btn btn-default btn-xs" id="connectionExport">
                <span class="glyphicon glyphicon-download-alt"></span> Export Configuration
              </button>
            </div>
          </div>
          <div class="panel-body">
            <div class="input-group">
              <span class="input-group-addon">Select Default</span>
              <select class="form-control" id="connectionSelect">
                <option value="CUSTOM">Custom</option>
              </select>
            </div>
            <div class="input-group">
              <span class="input-group-addon">Host</span>
              <input type="text" class="form-control" placeholder="example.csres.utexas.edu" id="inputHost">
            </div>
            <div class="input-group">
              <span class="input-group-addon">Rosbridge Port</span>
              <input type="text" class="form-control" placeholder="9090" id="inputRosbridgePort">
            </div>
            <div class="input-group">
              <span class="input-group-addon">Mjpeg Server Port</span>
              <input type="text" class="form-control" placeholder="8080" id="inputMjpegServerPort">
            </div>
          </div>
        </div>

        <div class="panel panel-default">
          <div class="panel-heading clearfix">
            <h3 class="panel-title pull-left">Subscriptions</h3>
            <div class="btn-group pull-right">
              <button type="button" class="btn btn-default btn-xs" id="subscriptionExport">
                <span class="glyphicon glyphicon-download-alt"></span> Export Configuration
              </button>
            </div>
          </div>
          <div class="panel-body">
            <div class="input-group">
              <span class="input-group-addon">Select Default</span>
              <select class="form-control" id="subscriptionSelect">
                <option value="CUSTOM">Custom</option>
              </select>
            </div>

            <h3 class="page-header">Enabled Widgets</h2>
            <div class="input-group">
              <span class="input-group-addon">
                <input type="checkbox" id="enabledVideo" checked>
              </span>
              <input type="text" class="form-control" value="Video" readonly="readonly">
            </div>
            <div class="input-group">
              <span class="input-group-addon">
                <input type="checkbox" id="enabledTeleop" checked>
              </span>
              <input type="text" class="form-control" value="Teleop" readonly="readonly">
            </div>
            <div class="input-group">
              <span class="input-group-addon">
                <input type="checkbox" id="enabledNavigation" checked>
              </span>
              <input type="text" class="form-control" value="Navigation" readonly="readonly">
            </div>
            <div class="input-group">
              <span class="input-group-addon">
                <input type="checkbox" id="enabledSensors" checked>
              </span>
              <input type="text" class="form-control" value="Sensors" readonly="readonly">
            </div>



            <div id="VideoTopics">
              <h3 class="page-header">Video Configuration</h3>

              <div class="input-group">
                <span class="input-group-addon">Video Quality</span>
                <input type="text" class="form-control" placeholder="Value from 0-100" id="videoQuality">
              </div>
              <br/>
              <br />
              <div id="videotopics">
              </div>
              <button type="button" class="btn btn-default btn-md" style="width:100%;" id="addVideoTopic">
                <span class="glyphicon glyphicon-plus"></span> Add More Topics
              </button>
            </div>

            <div id="SensorTopics">
              <h3 class="page-header">Sensor Configuration</h3>

              <div id="sensortopics">
              </div>
              <button type="button" class="btn btn-default btn-md" style="width:100%;" id="addSensorTopic">
                <span class="glyphicon glyphicon-plus"></span> Add More Topics
              </button>
            </div>

          </div>
        </div>
        

        <button type="button" class="btn btn-success btn-lg" style="width:100%;" id="connectROS">
          <span class="glyphicon glyphicon-off"></span> Connect
        </button>


        <!-- EXPORT MODAL FOR CONNECTION -->
        <div class="modal fade" id="connectionExportModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3 class="modal-title">Export Connection Configuration</h3>
              </div>
              <div class="modal-body">
                <p>Add the following code as a new addition to the <i>connectionConfig</i> variable in config.js located in the '/js/' directory (make sure to add commas between entries as need be):</p>
                <pre id="connectionExportPre" ></pre>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

        <!-- EXPORT MODAL FOR SUBSCRIPTIONS -->
        <div class="modal fade" id="subscriptionExportModal">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3 class="modal-title">Export Subscription Configuration</h3>
              </div>
              <div class="modal-body">
                <p>Add the following code as a new addition to the <i>subscriptionConfig</i> variable in config.js located in the '/js/' directory (make sure to add commas between entries as need be):</p>
                <pre id="subscriptionExportPre" ></pre>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div>
          </div>
        </div>

      </div>



      <!-- DASHBOARD SCREEN -->
      <div id="dashboardcontainer" style="display:none;">
          <h1 class="page-header">Dashboard</h1>


          <div class="panel-group" id="divLog">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h4 class="panel-title">
                    Message Log
                </h4>
              </div>
              <div id="collapseLog" class="panel-collapse collapse in">
                <div class="panel-body">
                  <div style="height:100px;display:block;overflow-y:auto;" id="scrollLog">
                    <table class="table table-striped" style="overflow: scroll;" >
                      <thead>
                         <tr>
                           <th>From</th>
                           <th>Timestamp</th>
                           <th>Message</th>
                         </tr>
                      </thead>
                      <tbody id="tbodyLog">
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <div class="panel-group" id="divVideo">
            <div class="panel panel-default">

              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#divVideo" href="#collapseVideo">
                    Video
                  </a>
                </h4>
              </div>

              <div id="collapseVideo" class="panel-collapse collapse out">
                <div class="panel-body">
                  <center>
                     <div id="mjpegVideoScreen">
                     </div>
                  </center>
                </div>
              </div>
            </div>
          </div>



          <div class="panel-group" id="divTeleop">
            <div class="panel panel-default">

              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#divTeleop" href="#collapseTeleop">
                    Teleoperation
                  </a>
                </h4>
              </div>

              <div id="collapseTeleop" class="panel-collapse collapse out">
                <div class="panel-body">
                  <center>
                     <div id="teleopSpeedLabel"></div>
                     <div id="teleopSpeedSlider"></div>
                     <br/>
                     <br/>
                     <div>
                        <button type="button" class="btn btn-default btn-xlarge" id="teleopLeftKey">
                          <span class="glyphicon glyphicon-arrow-left"></span>
                        </button>
                        <button type="button" class="btn btn-default btn-xlarge" id="teleopUpKey">
                          <span class="glyphicon glyphicon-arrow-up"></span>
                        </button>
                        <button type="button" class="btn btn-default btn-xlarge" id="teleopRightKey">
                          <span class="glyphicon glyphicon-arrow-right"></span>
                        </button>
                        <br/>
                        <!-- <button type="button" class="btn btn-default btn-xlarge" onclick="simulateKeyPress('')">
                          <span class="glyphicon glyphicon-stop"></span>
                        </button> -->
                        <button type="button" class="btn btn-default btn-xlarge" id="teleopTurnLeftKey">
                          <span class="glyphicon glyphicon-repeat icon-rotate icon-flipped"></span>
                        </button>
                        <button type="button" class="btn btn-default btn-xlarge" id="teleopDownKey">
                          <span class="glyphicon glyphicon-arrow-down"></span>
                        </button>
                        <button type="button" class="btn btn-default btn-xlarge" id="teleopTurnRightKey">
                          <span class="glyphicon glyphicon-repeat"></span>
                        </button>
                     </div>
                  </center>
                </div>
              </div>
            </div>
          </div>


          <div class="panel-group" id="divNav">
            <div class="panel panel-default">

              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#divNav" href="#collapseNav">
                    Navigation
                  </a>
                </h4>
              </div>

              <div id="collapseNav" class="panel-collapse collapse out">
                <div class="panel-body">
                  <center>
                     <div id="navWindow">
                     </div>
                     <button type="button" class="btn btn-default btn-xlarge" id="navLeftKey" onclick="navAction('left')">
                        <span class="glyphicon glyphicon-arrow-left"></span>
                     </button>
                     <button type="button" class="btn btn-default btn-xlarge" id="navDownKey" onclick="navAction('down')">
                        <span class="glyphicon glyphicon-arrow-down"></span>
                     </button>
                     <button type="button" class="btn btn-default btn-xlarge" id="navUpKey" onclick="navAction('up')">
                        <span class="glyphicon glyphicon-arrow-up"></span>
                     </button>
                     <button type="button" class="btn btn-default btn-xlarge" id="navRightKey" onclick="navAction('right')">
                        <span class="glyphicon glyphicon-arrow-right"></span>
                     </button>
                     <button type="button" class="btn btn-default btn-xlarge" id="navZoomOut" onclick="navAction('zoomout')">
                         <span class="glyphicon glyphicon-zoom-out"></span>
                     </button>
                     <button type="button" class="btn btn-default btn-xlarge" id="navZoomIn" onclick="navAction('zoomin')">
                         <span class="glyphicon glyphicon-zoom-in"></span>
                     </button>
                  </center>
                </div>
              </div>
            </div>
          </div>



          <div class="panel-group" id="divSensors">
            <div class="panel panel-default">

              <div class="panel-heading">
                <h4 class="panel-title">
                  <a data-toggle="collapse" data-parent="#divSensors" href="#collapseSensors">
                    Sensors
                  </a>
                </h4>
              </div>

              <div id="collapseSensors" class="panel-collapse collapse out">
                <div class="panel-body">
                  <div class="table-responsive">
                   <table class="table table-striped" style="overflow: scroll;" >

                     <thead>
                       <tr>
                         <th>Topic</th>
                         <th class='hidden-xs hidden-sm'>Type</th>
                         <th>Updated</th>
                         <th>Value</th>
                       </tr>
                     </thead>

                     <!-- tbodyTableSubscriptions is filled out with initializeSubscribers() -->
                     <tbody id="tbodyTableSubscriptions">
                     </tbody>

                   </table>
                 </div>
                </div>
              </div>
            </div>
          </div>
        </div>

    </div>
    

    <script>

      
      //This function is called when the "CONNECT" button is pressed or when url parameters are loaded in
      //It sets up the proper variables, then connects to ROSBRIDGE
      function connectToROS()
      {
        //Get connection info
        hostInfo = createConnectionConfig($('#inputHost').val(), $('#inputRosbridgePort').val(), $('#inputMjpegServerPort').val());
        rosBridgeAddress = "ws://" + hostInfo.Host + ":" + hostInfo.RosbridgePort;
        rosMjpegVideoAddress = hostInfo.Host;
        rosMjpegVideoPort = hostInfo.MjpegServerPort;

        //Get enabled widgets
        enabledVideo = $('#enabledVideo').prop('checked');
        enabledTeleop = $('#enabledTeleop').prop('checked');
        enabledNavigation = $('#enabledNavigation').prop('checked');
        enabledSensors = $('#enabledSensors').prop('checked');


        //Get subscription info
        //video quality
        if(enabledVideo)
        {
          rosMjpegVideoQuality = $('#videoQuality').val();
          //video info
          rosMjpegVideoTopics = [];
          $('#videotopics').find('input').each(function () {
            if(this.value!="")
            {
              rosMjpegVideoTopics.push(this.value);
            }
          });
        }
        else
        {
          rosMjpegVideoQuality = 1;
          rosMjpegVideoTopics = [];
        }


        //sensor info
        if(enabledSensors)
        {
          tableSubscriptions = [];
          $('#sensortopics').children('div').each(function () {
            // rosMjpegVideoTopics.push(this.value);
            var tempTopicBuffer = [];
            $(this).find('input').each(function(){
              tempTopicBuffer.push(this.value);
            });
            if(tempTopicBuffer[0] != "")
            {
              var splitSubtopics = tempTopicBuffer[2].split(/[\s,]+/);
              tableSubscriptions.push(createSensorSubscriptionObject(tempTopicBuffer[0], tempTopicBuffer[1], splitSubtopics));
            }
          });
        }
        else
        {
          tableSubscriptions = [];
        }

        rosMjpegServerInfo = {
                               Host : rosMjpegVideoAddress,
                               Port : rosMjpegVideoPort,
                               Quality : rosMjpegVideoQuality, //0-100
                               Topics : rosMjpegVideoTopics,
                               Labels : rosMjpegVideoTopics
                              }





        $('#configurationcontainer').css({ "display": 'none'});
        $('#dashboardcontainer').css({ "display": ''});

        //Enable widgets that have been selected
        if(enabledVideo){ $('#divVideo').css({ "display": ''}); }
        else{ $('#divVideo').css({ "display": 'none'}); }

        if(enabledTeleop){ $('#divTeleop').css({ "display": ''}); }
        else{ $('#divTeleop').css({ "display": 'none'}); }

        if(enabledNavigation){ $('#divNav').css({ "display": ''}); }
        else{ $('#divNav').css({ "display": 'none'}); }

        if(enabledSensors){ $('#divSensors').css({ "display": ''}); }
        else{ $('#divSensors').css({ "display": 'none'}); }

        //initialize the components of the dashboard
        initializeROS();
        initializeSensorTable();
        initializeLogSubscriptions();
      }



      //Connect button has been pressed
      $('#connectROS').click( function() {
        connectToROS();
      });



      // Fires when the "Export" button next to the connection configuration is pressed
      // Shows the user the proper variable to put into the config.js file
      $('#connectionExport').click( function(){
          var exportStr = JSON.stringify(createConnectionConfig($('#inputHost').val(), $('#inputRosbridgePort').val(), $('#inputMjpegServerPort').val()), null, 2);
          exportStr = exportStr.replace(/\"([^(\")"]+)\":/g,"$1:");
          exportStr = '"your_config_name_here" : ' + exportStr;
          $('#connectionExportPre').text(exportStr);
          $('#connectionExportModal').modal('show');
      });

      // Fires when the "Export" button next to the subscription configuration is pressed
      // Shows the user the proper variable to put into the config.js file
      $('#subscriptionExport').click( function(){
          var exportStr = JSON.stringify(createConfigurationObject(), null, 2);
          exportStr = exportStr.replace(/\"([^(\")"]+)\":/g,"$1:");
          exportStr = '"your_config_name_here" : ' + exportStr;
          $('#subscriptionExportPre').text(exportStr);
          $('#subscriptionExportModal').modal('show');
      });

      // Used by the subscription export to create the proper variable info
      function createConfigurationObject()
      {
        var tempVideotopics = [];
        if($('#enabledVideo').prop('checked'))
        {
          $('#videotopics').find('input').each(function () {
              if(this.value!="")
              {
                tempVideotopics.push(this.value);
              }
            });
        }

        var tempSensortopics = [];
        if($('#enabledSensors').prop('checked'))
        {
          $('#sensortopics').children('div').each(function () {
            // rosMjpegVideoTopics.push(this.value);
            var tempTopicBuffer = [];
            $(this).find('input').each(function(){
              tempTopicBuffer.push(this.value);
            });
            if(tempTopicBuffer[0] != "")
            {
              var splitSubtopics = tempTopicBuffer[2].split(/[\s,]+/);
              tempSensortopics.push(createSensorSubscriptionObject(tempTopicBuffer[0], tempTopicBuffer[1], splitSubtopics));
            }
          });
        }



        var tempConfigObject = {
              Enabled: {
                          Video:   $('#enabledVideo').prop('checked'),
                          Teleop:  $('#enabledTeleop').prop('checked'),
                          Nav:     $('#enabledNavigation').prop('checked'),
                          Sensors: $('#enabledSensors').prop('checked')
                        },
              VideoQuality: $('#videoQuality').val(),
              VideoTopics: tempVideotopics,
              SensorTopics: tempSensortopics
                          };



        return tempConfigObject;
      }


        // Adds an entry to the log window at the top of the screen and scrolls down to the bottom
        function logToScreen(fromName, logInput)
        {
            var logMessage = logInput;
            if(logInput !== null && typeof logInput === 'object')
            {
              logMessage = JSON.stringify(logInput, null, 2);
            }
            var tbodyLog = document.getElementById('tbodyLog');
            var trLog = document.createElement('tr');

            var tdFrom = document.createElement('td');
            tdFrom.innerHTML = fromName;

            var tdUpdated = document.createElement('td');
            tdUpdated.innerHTML = formatNowTimestamp();

            var tdValue = document.createElement('td');
            tdValue.innerHTML = logMessage;

            trLog.appendChild(tdFrom);
            trLog.appendChild(tdUpdated);
            trLog.appendChild(tdValue);
            tbodyLog.appendChild(trLog);

            //scroll to bottom of div
            $('#scrollLog').scrollTop($('#scrollLog')[0].scrollHeight);
            // $("#scrollLog").animate({ scrollTop: $('#scrollLog')[0].scrollHeight}, 1000);
        }


      // Adds a field to the list of video topics on the configuration window
      // topicname is used as the value of the input
      function addVideoTopic(topicname)
      {
        $("#videotopics").append('<div class="input-group"><span class="input-group-addon">Topic Name</span><input type="text" class="form-control" placeholder="/nav_kinect/rgb/image_raw" value="' + topicname + '"></div><br/>');
      }

      // Adds the appropriate fields to the list of sensor subscriptions on the configuration window
      // the input variables are used as the initial values of the inputs
      function addSensorTopic(topicname, messagetype, topicrestrictions)
      {
        var topicrestrictionsString = '';
        for (var i = 0; i < topicrestrictions.length; i++) {
            topicrestrictionsString = topicrestrictionsString + topicrestrictions[i];
            if(i != topicrestrictions.length-1)
            {
              topicrestrictionsString = topicrestrictionsString + ', ';
            }
            //Do something
        }
        $("#sensortopics").append('<div><div class="input-group"><span class="input-group-addon">Topic Name</span><input type="text" class="form-control" placeholder="/odom" value="' + topicname + '"></div><div class="input-group"><span class="input-group-addon">Message Type</span><input type="text" class="form-control" placeholder="nav_msgs/Odometry" value="' + messagetype + '"></div><div class="input-group"><span class="input-group-addon">SubTopics</span><input type="text" class="form-control" placeholder="twist/twist/linear, twist/twist/angular" value="' + topicrestrictionsString + '"></div></div><br/>');
      }

      //Clears the list of video fields on the configuration screen
      function clearVideoTopics()
      {
        $("#videotopics").empty();
      }

      //Clears the list of sensor fields on the configuration screen
      function clearSensorTopics()
      {
        $("#sensortopics").empty();
      }

      // Fires when the "Add" button is pressed for the video topics on the configuration screen
      $('#addVideoTopic').click( function() {
        addVideoTopic('');
      });

      // Fires when the "Add" button is pressed for the sensor topics on the configuration screen
      $('#addSensorTopic').click( function() {
        addSensorTopic('','',[]);
      });

      
      // Fires when a new subscription default is chosen on the configuration screen
      $('#subscriptionSelect').change( function() {    
        clearVideoTopics();
        clearSensorTopics();
        if($(this).val()=="CUSTOM")
        {
          // The user wants to put in their own values, reset all the fields
          addSensorTopic('','',[]);
          addVideoTopic('');
          $('#enabledVideo').prop('checked', true);
          $('#enabledTeleop').prop('checked', true);
          $('#enabledNavigation').prop('checked', true);
          $('#enabledSensors').prop('checked', true);
          $('#videoQuality').val('');
          $('#VideoTopics').css({ "display": ''});
          $('#SensorTopics').css({ "display": ''});
        }
        else
        {
          //initialize content
          var subscrConfig = subscriptionConfig[$(this).val()];
          var subscrVideo = subscrConfig.VideoTopics;
          var subscrSensor = subscrConfig.SensorTopics;

          $('#videoQuality').val(subscrConfig.VideoQuality);
          $('#enabledVideo').prop('checked', subscrConfig.Enabled.Video);
          $('#enabledTeleop').prop('checked', subscrConfig.Enabled.Teleop);
          $('#enabledNavigation').prop('checked', subscrConfig.Enabled.Nav);
          $('#enabledSensors').prop('checked', subscrConfig.Enabled.Sensors);

          if(subscrConfig.Enabled.Video)
          {
            $('#VideoTopics').css({ "display": ''});
          }
          else
          {
            $('#VideoTopics').css({ "display": 'none'});
          }

          if(subscrConfig.Enabled.Nav)
          {
            $('#NavTopics').css({ "display": ''});
          }
          else
          {
            $('#NavTopics').css({ "display": 'none'});
          }

          if(subscrConfig.Enabled.Sensors)
          {
            $('#SensorTopics').css({ "display": ''});
          }
          else
          {
            $('#SensorTopics').css({ "display": 'none'});
          }


          for(var i=0; i<subscrVideo.length; i++)
          {
            addVideoTopic(subscrVideo[i]);
          }

          for(var i=0; i<subscrSensor.length; i++)
          {
            addSensorTopic(subscrSensor[i].TopicName, subscrSensor[i].MessageType, subscrSensor[i].SubTopicNames);
          }

        }

      });

      // Fires when a new connection default is chosen on the configuration screen
       $('#connectionSelect').change( function() {    
        if($(this).val()=="CUSTOM")
        {
          // The user wants to put in their own values, reset all the fields
          hostInfo = createConnectionConfig("","","");
        }
        else
        {
          hostInfo = connectionConfig[$(this).val()];
        }

        inputHost.value=hostInfo.Host;
        inputRosbridgePort.value=hostInfo.RosbridgePort;
        inputMjpegServerPort.value=hostInfo.MjpegServerPort;

      });

      $("#enabledVideo").change(function() {
          if(this.checked)
          {
            $('#VideoTopics').css({ "display": ''});
          }
          else
          {
            $('#VideoTopics').css({ "display": 'none'});
          }
      });

      $("#enabledNavigation").change(function() {
          if(this.checked)
          {
            $('#NavTopics').css({ "display": ''});
          }
          else
          {
            $('#NavTopics').css({ "display": 'none'});
          }
      });

      $("#enabledSensors").change(function() {
          if(this.checked)
          {
            $('#SensorTopics').css({ "display": ''});
          }
          else
          {
            $('#SensorTopics').css({ "display": 'none'});
          }
      });

      //When minimizing accordion for sensors, delete the subscribers so you're not wasting bandwith
      $('#collapseSensors').on('hidden.bs.collapse', function (e) {
          deleteSensorSubscribers();
      })
      //Since the subscribers were deleted upon collapsing accordion, recreate them when expanding
      $('#collapseSensors').on('shown.bs.collapse', function (e) {
          createSensorSubscribers();
      })

      //When minimizing accordion for videos, clear the screen so you're not wasting bandwith
      $('#collapseVideo').on('hidden.bs.collapse', function (e) {
           deleteVideoSubscribers();
      })
      //Since the subscribers were deleted upon collapsing accordion, recreate them when expanding
      $('#collapseVideo').on('shown.bs.collapse', function (e) {
          createVideoSubscribers();
      })


      //When minimizing accordion for navigation, clear the screen so you're not wasting bandwith
      $('#collapseNav').on('hidden.bs.collapse', function (e) {
           deleteNavSubscribers();
      })
      //Since the subscribers were deleted upon collapsing accordion, recreate them when expanding
      $('#collapseNav').on('shown.bs.collapse', function (e) {
          createNavSubscribers();
      })

      //When minimizing accordion for navigation, clear the screen so you're not wasting bandwith
      $('#collapseTeleop').on('hidden.bs.collapse', function (e) {
           deleteTeleopSubscribers();
      })
      //Since the subscribers were deleted upon collapsing accordion, recreate them when expanding
      $('#collapseTeleop').on('shown.bs.collapse', function (e) {
          createTeleopSubscribers();
      })


    </script>

  </body>
</html>
